using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using System.Windows;
using System.Windows.Controls;
using System.Windows.Data;
using System.Windows.Documents;
using System.Windows.Input;
using System.Windows.Media;
using System.Windows.Media.Imaging;
using System.Windows.Navigation;
using System.IO;
using SoulsFormats;
using System.ComponentModel;

namespace DemonSoulsItemRandomiser
{
    public partial class MainWindow : Window, INotifyPropertyChanged
    {
        string pathToParamDataFile = Directory.GetCurrentDirectory() + @"\Data\gameparamna.parambnd.dcx";
        string pathToParamDef = Directory.GetCurrentDirectory() + @"\Data\paramdef\paramdef.paramdefbnd.dcx";

        public event PropertyChangedEventHandler PropertyChanged;

        public bool RandomiseWorldTreasure { get; set;}
        public bool RandomiseKeyItems{ get; set; }
        public bool RandomiseStartingEquipment { get; set; }
        public bool RandomiseEnemyDropTables { get; set; }
        public bool RandomiseShopInventory { get; set; }

        //ID Lists
        //Null and un-used objects
        List<long> forbiddenItemLotIds;

        //The orbs enemy drop after they die
        List<long> enemyDropTableLotIds;

        //World Drops (Glowing orbs on map)
        List<long> treasureItemLots;

        public MainWindow()
        {
            InitializeComponent();
            DataContext = this;
            InitIDLists();
            RandomiseItems();
        }

        private void RandomiseItems()
        {
            // Reading an original paramdefbnd
            var paramdefs = new Dictionary<string, PARAMDEF>();
            var paramdefbnd = BND3.Read(pathToParamDef);

            foreach (BinderFile file in paramdefbnd.Files)
            {
                var paramdef = PARAMDEF.Read(file.Bytes);
                paramdefs[paramdef.ParamType] = paramdef;
            }

            var parms = new Dictionary<string, PARAM>();
            var parambnd = BND3.Read(pathToParamDataFile);

            foreach (BinderFile file in parambnd.Files)
            {
                string name = Path.GetFileNameWithoutExtension(file.Name);
                var param = PARAM.Read(file.Bytes);
                param.ApplyParamdef(paramdefs[param.ParamType]);
                parms[name] = param;
            }

            PARAM weapons = parms["EquipParamWeapon"];
            PARAM armor = parms["EquipParamProtector"];
            PARAM rings = parms["EquipParamAccessory"];
            PARAM consumables = parms["EquipParamGoods"];
            PARAM itemLots = parms["ItemLotParam"];

            Random rng = new Random();

            //Swapping treasure
            foreach (var item in itemLots.Rows)
            {
                if (treasureItemLots.Contains(item.ID))
                {
                    PARAM.Row rowToSwapWith = itemLots.Rows[rng.Next(itemLots.Rows.Count)];

                    if (!treasureItemLots.Contains(rowToSwapWith.ID))
                    {
                        bool validRowFound = false;

                        while (validRowFound == false)
                        {
                            rowToSwapWith = itemLots.Rows[rng.Next(itemLots.Rows.Count)];
                            var rowToSwapWithId = rowToSwapWith["lotItemId01"].Value;
                            var rowToSwapWithCategory = rowToSwapWith["lotItemCategory01"].Value;
                            if (treasureItemLots.Contains(rowToSwapWith.ID) && Convert.ToInt64(rowToSwapWithId) != 0 && Convert.ToInt64(rowToSwapWithCategory) != -1) validRowFound = true;
                        }
                    }

                    if (Convert.ToInt64(item["lotItemId01"].Value) != 0 && Convert.ToInt64(item["lotItemCategory01"].Value) != -1)
                    {
                        var rowToSwapWithIdTemp = rowToSwapWith["lotItemId01"].Value;
                        var rowToSwapWithCategoryTemp = rowToSwapWith["lotItemCategory01"].Value;
                        var rowToSwapWithItemNumber = rowToSwapWith["lotItemNum01"].Value;

                        var originalRowTemp = item["lotItemId01"].Value;
                        var originalRowCategoryTemp = item["lotItemCategory01"].Value;
                        var originalRowItemNumber = item["lotItemNum01"].Value;

                        item["lotItemId01"].Value = rowToSwapWithIdTemp;
                        item["lotItemCategory01"].Value = rowToSwapWithCategoryTemp;
                        item["lotItemNum01"].Value = rowToSwapWithItemNumber;

                        rowToSwapWith["lotItemId01"].Value = originalRowTemp;
                        rowToSwapWith["lotItemCategory01"].Value = originalRowCategoryTemp;
                        rowToSwapWith["lotItemNum01"].Value = originalRowItemNumber;
                    }
                }
            }

            //Swapping EnemyDrop tables

            //Swapping shop inventory


            foreach (BinderFile file in parambnd.Files)
            {
                string name = Path.GetFileNameWithoutExtension(file.Name);
                file.Bytes = parms[name].Write();
            }
            parambnd.Write(pathToParamDataFile);
        }

        private void InitIDLists()
        {
            forbiddenItemLotIds = new List<long>
            {
                0,1,2,16244,16456,16457,16652,16657,310022,60,70,80,200,280,290,300,320,10100,10169,10170,10171,10172,10173,10174,10175,10176,10177,10178,10179,10180,10181,10182,10183,10184,10185,10195,10196,10197,10198,
                10199,10223,10250,10251,10252,10253,10254,10255,10256,10257,10258,10259,10270,10271,10272,10273,10274,10275,10276,10277,10279,10281,10415,10416,10417,10418,10440,10441,10442,10443,10456,10457,10458,10459,
                10470,10471,10472,10473,10474,10475,10476,10477,10478,10480,10481,10490,10519,10530,10531,10532,10533,10535,10540,10542,10570,10571,10572,10573,10574,10575,10576,10577,10578,10579,10580,10581,10651,10652,
                10653,10654,10655,10656,10657,10658,10659,10660,10670,10672,10673,10674,10675,10676,10677,10678,10680,10681,10715,10870,10871,10872,10873,10951,10970,10971,10972,10973,15056,15062,15069,15070,15071,15072,
                15073,15074,15075,15076,15077,15078,15079,15084,15085,15086,15090,15091,15099,15100,15101,15102,15103,15200,15201,15202,15203,15300,15301,15302,15303,15400,15401,15521,15522,15523,15524,15525,15526,15531,
                15532,15533,15534,15535,15536,15702,16206,16207,16208,16209,16210,16211,16212,16213,16214,16215,16216,16217,16219,16220,16221,16456,16457,16447,16448,16449,16450,16451,16452,16453,16454,16455,16456,16457,
                16458,16459,16460,16461,16550,16551,16553,16555,16556,16557,16565,16571,16572,16600,16602,16603,16604,16605,16606,16607,16608,16609,16610,16611,16612,16613,16615,16618,16619,16620,16621,16622,16623,16624,
                16625,16626,16627,16628,16629,16641,16673,16674,16675,16676,16677,16678,16679,16680,16681,16682,16683,16684,16685,16686,16687,16688,16689,100000,100001,220040,230040,310022,310027,310062,320022,320027,
                320030,320050,320051,320052,320055,320056,320057,320122,320127,400021,400051,400090,410060,410071,500002,500012,500052,500062,510002,510012,510020,510041,510050,520002,520011,520012,610002,610003,610022,
                610040,610041,610052,610072,610073,610082,620003,620004,620031,620054,620062,620063,620072,620073,630054,900003,900004,900005,900011,900016,900017,900021,900022,900023,900027,900028,900029,900039,900040,
                900041,900046,900047,
                210000,210001,210005,210006,210010,210011,210020,210021,210030,210031,210040,210041,210045,210046,210050,210051,210060,210061,210065,210066,210070,210071,210075,210076,210080,210081,210085,210086,210090,
                210091,210092,220000,220001,220010,220011,220020,220021,220025,220026,220030,220031,220040,220045,220046,220050,220051,220055,220056,220060,220061,220065,220066,220070,220071,220080,220081,220090,220091,220100,
                220101,230000,230001,230010,230011,230020,230021,230025,230026,230030,230031,230040,230050,230051,230055,230056,230060,230061,230065,230066,230070,230071,230072,230080,230081,230090,230091,230095,230096,230100,
                230101,230110,230111,240000,240001,240010,240011,240020,240021,240025,240026,240030,240031,240100,240101,240110,240111,240040,240041,240045,240046,240050,240051,240055,240056,240060,240061,240070,240071,240080,
                240081,240082,240090,240091,310000,310001,310005,310006,310010,310011,310015,310016,310020,310021,310022,310025,310026,310027,310030,310050,310051,310060,310061,310062,310070,320000,320001,320010,320011,320020,
                320021,320022,320025,320026,320027,320030,320050,320051,320052,320055,320056,320057,320070,320071,320090,320091,320100,320101,320110,320120,320121,320122,320125,320126,320127,330000,330010,330011,400000,400001,
                400010,400011,400020,400021,400030,400031,400032,400033,400034,400040,400041,400050,400051,400060,400070,400071,400080,400090,410000,410001,410010,410011,410020,410030,410031,410040,410041,410050,410051,410060,
                410070,410071,410080,410090,420000,420001,420010,500000,500001,500002,500010,500011,500012,500020,500030,500040,500041,500050,500051,500052,500060,500061,500062,500070,500071,510000,510001,510002,510010,510011,
                510012,510020,510021,510022,510023,510030,510031,510032,510040,510041,510050,510051,510052,510053,510054,510060,510070,510071,510080,510081,510082,510090,510091,510092,510100,510101,510110,510111,510120,510121,
                510130,510131,520000,520001,520002,520010,520011,520012,520030,520031,520040,610000,610001,610002,610003,610010,610011,610012,610013,610020,610021,610022,610030,610031,610032,610040,610041,610050,610051,610052,
                610053,610054,610055,610056,610057,610060,610061,610062,610063,610070,610071,610072,610073,610080,610081,610082,610090,610100,610101,620000,620001,620002,620003,620004,620010,620011,620012,620013,620020,620021,
                620030,620031,620040,620041,620050,620051,620052,620053,620054,620060,620061,620062,620063,620070,620071,620072,620073,620080,620090,620100,620110,630050,630051,630052,630053,630054,810000,810001,810002,900000,
                900001,900002,900003,900004,900005,900006,900007,900008,900009,900010,900011,900012,900013,900014,900015,900016,900017,900018,900019,900020,900021,900022,900023,900024,900025,900026,900027,900028,900029,900030,
                900031,900032,900033,900034,900035,900036,900037,900038,900039,900040,900041,900042,900043,900044,900045,900046,900047
            };

            enemyDropTableLotIds = new List<long>
            {
                210000,210001,210005,210006,210010,210011,210020,210021,210030,210031,210040,210041,210045,210046,210050,210051,210060,210061,210065,210066,210070,210071,210075,210076,210080,210081,210085,210086,210090,
                210091,210092,220000,220001,220010,220011,220020,220021,220025,220026,220030,220031,220040,220045,220046,220050,220051,220055,220056,220060,220061,220065,220066,220070,220071,220080,220081,220090,220091,220100,
                220101,230000,230001,230010,230011,230020,230021,230025,230026,230030,230031,230040,230050,230051,230055,230056,230060,230061,230065,230066,230070,230071,230072,230080,230081,230090,230091,230095,230096,230100,
                230101,230110,230111,240000,240001,240010,240011,240020,240021,240025,240026,240030,240031,240100,240101,240110,240111,240040,240041,240045,240046,240050,240051,240055,240056,240060,240061,240070,240071,240080,
                240081,240082,240090,240091,310000,310001,310005,310006,310010,310011,310015,310016,310020,310021,310022,310025,310026,310027,310030,310050,310051,310060,310061,310062,310070,320000,320001,320010,320011,320020,
                320021,320022,320025,320026,320027,320030,320050,320051,320052,320055,320056,320057,320070,320071,320090,320091,320100,320101,320110,320120,320121,320122,320125,320126,320127,330000,330010,330011,400000,400001,
                400010,400011,400020,400021,400030,400031,400032,400033,400034,400040,400041,400050,400051,400060,400070,400071,400080,400090,410000,410001,410010,410011,410020,410030,410031,410040,410041,410050,410051,410060,
                410070,410071,410080,410090,420000,420001,420010,500000,500001,500002,500010,500011,500012,500020,500030,500040,500041,500050,500051,500052,500060,500061,500062,500070,500071,510000,510001,510002,510010,510011,
                510012,510020,510021,510022,510023,510030,510031,510032,510040,510041,510050,510051,510052,510053,510054,510060,510070,510071,510080,510081,510082,510090,510091,510092,510100,510101,510110,510111,510120,510121,
                510130,510131,520000,520001,520002,520010,520011,520012,520030,520031,520040,610000,610001,610002,610003,610010,610011,610012,610013,610020,610021,610022,610030,610031,610032,610040,610041,610050,610051,610052,
                610053,610054,610055,610056,610057,610060,610061,610062,610063,610070,610071,610072,610073,610080,610081,610082,610090,610100,610101,620000,620001,620002,620003,620004,620010,620011,620012,620013,620020,620021,
                620030,620031,620040,620041,620050,620051,620052,620053,620054,620060,620061,620062,620063,620070,620071,620072,620073,620080,620090,620100,620110,630050,630051,630052,630053,630054,810000,810001,810002,900000,
                900001,900002,900003,900004,900005,900006,900007,900008,900009,900010,900011,900012,900013,900014,900015,900016,900017,900018,900019,900020,900021,900022,900023,900024,900025,900026,900027,900028,900029,900030,
                900031,900032,900033,900034,900035,900036,900037,900038,900039,900040,900041,900042,900043,900044,900045,900046,900047
            };

            treasureItemLots = new List<long>
            {
                10120,10121,10122,10123,10124,10125,10126,10127,10128,10129,10130,10131,10132,10133,10134,10135,10136,10137,10138,10139,10140,10141,10142,10143,10144,10145,10146,10147,10148,10149,10150,10151,10152,10153,10154,
                10155,10156,10157,10158,10159,10160,10161,10162,10163,10164,10165,10166,10167,10168,10194,10200,10201,10202,10203,10204,10205,10206,10207,10208,10209,10210,10211,10212,10213,10214,10215,10216,10217,10235,10236,
                10237,10238,10239,10240,10241,10242,10243,10244,10245,10246,10247,10248,10249,10260,10261,10262,10263,10264,10265,10266,10267,10268,10269,10282,10283,10284,10285,10286,10287,10288,10289,10290,10291,10292,10293,
                10294,10295,10296,10297,10298,10299,10300,10301,10302,10303,10330,10331,10332,10360,10361,10362,10363,10364,10365,10366,10367,10400,10401,10402,10403,10405,10406,10407,10408,10409,10410,10411,10412,10413,10414,
                10419,10420,10421,10422,10423,10424,10425,10426,10427,10428,10429,10430,10431,10432,10433,10434,10435,10436,10437,10438,10454,10455,10460,10461,10462,10479,10491,10500,10501,10502,10503,10504,10505,10506,10507,
                10508,10509,10510,10511,10512,10513,10514,10515,10516,10517,10518,10520,10521,10522,10523,10524,10525,10526,10527,10528,10529,10536,10537,10538,10539,10541,10543,10544,10545,10546,10547,10548,10557,10558,10559,
                10560,10561,10562,10563,10564,10565,10566,10567,10568,10569,10582,10583,10584,10585,10586,10587,10589,10590,10591,10592,10593,10594,10595,10596,10597,10600,10601,10602,10603,10604,10605,10606,10607,10608,10609,
                10610,10611,10612,10613,10614,10615,10616,10617,10618,10619,10620,10621,10622,10623,10624,10625,10626,10627,10628,10629,10630,10631,10632,10633,10634,10635,10636,10637,10638,10639,10640,10641,10642,10643,10644,
                10645,10646,10647,10648,10649,10661,10662,10663,10664,10665,10666,10667,10668,10669,10671,10679,10682,10683,10684,10685,10686,10687,10688,10689,10690,10691,10692,10693,10694,10695,10696,10697,10698,10740,10741,
                10750,10751,10760,10761,10810,10811,10812,10813,10814,10815,10816,10850,10860,10902,10974,10975,10976,10977,11000,11001,15001,15002,15003,15004,15005,15006,15007,15008,15009,15010,15011,15012,15013,15014,15015,
                15016,15017,15018,15019,15020,15021,15022,15023,15024,15025,15026,15027,15028,15029,15030,15031,15032,15033,15034,15041,15042,15043,15044,15045,15046,15047,15048,15049,15050,15051,15052,15053,15054,15055,15057,
                15058,15059,15060,15061,15063,15064,15065,15066,15067,15068,15081,15082,15083,15084,15085,15086,15087,15088,15089,15092,15093,15094,15095,15096,15097,15098,15402,15403,15500,15501,15502,15503,15527,15528,15529,
                15530,15537,15538,15539,15600,15601,15700,15701,16200,16201,16202,16203,16204,16205,16218,16230,16231,16232,16233,16234,16235,16236,16237,16238,16239,16240,16241,16242,16243,16290,16400,16401,16402,16403,16404,
                16405,16406,16407,16408,16409,16410,16411,16412,16413,16414,16415,16416,16417,16418,16419,16420,16421,16422,16423,16424,16425,16426,16427,16428,16429,16430,16431,16432,16433,16434,16435,16436,16437,16438,16439,
                16440,16441,16442,16443,16444,16445,16446,16447,16462,16463,16470,16471,16472,16473,16474,16475,16500,16501,16502,16503,16504,16505,16506,16507,16508,16509,16510,16511,16512,16513,16514,16515,16516,16517,16518,
                16519,16520,16521,16522,16523,16524,16525,16526,16527,16528,16529,16530,16531,16532,16533,16534,16535,16536,16537,16538,16539,16540,16541,16542,16543,16544,16545,16546,16547,16548,16549,16552,16554,16558,16559,
                16560,16561,16562,16563,16564,16566,16567,16568,16569,16570,16573,16574,16575,16576,16580,16581,16590,16591,16601,16614,16616,16617,16640,16650,16651,16652,16653,16654,16655,16656,16657,16658,16659,16660,16661,
                16662,16663,16664,16665,16666,16667,16668,16669,16670,16671,16672,10731, 10190, 10191, 10192, 10193
            };
        }
    }
}
